<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GemAI - ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <!-- iOS 10 Safariã¨ã®äº’æ›æ€§ã‚’æœ€å¤§é™ã«é«˜ã‚ã‚‹ãŸã‚ã€Tailwindã‚„è¤‡é›‘ãªCSSã¯ä½¿ç”¨ã›ãšã€ã‚·ãƒ³ãƒ—ãƒ«ãªFlexboxã¨æ¨™æº–CSSã‚’ä½¿ç”¨ã—ã¾ã™ -->
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆã¨åŸºæœ¬è¨­å®š */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0; /* è–„ã„èƒŒæ™¯ */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 10px;
        }
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        header {
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        nav {
            display: flex;
            justify-content: space-around;
        }
        .tab-button {
            flex: 1;
            padding: 10px 5px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: color 0.2s, border-bottom 0.2s;
            white-space: nowrap;
        }
        .tab-active {
            color: #007aff; /* iOS Blue */
            border-bottom: 3px solid #007aff;
            font-weight: bold;
        }
        /* å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ */
        .input-area {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            resize: none;
        }
        .button {
            background-color: #007aff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .button:disabled {
            background-color: #a8d5ff;
            cursor: default;
        }
        .button.secondary {
            background-color: #ccc;
            color: #333;
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #messages-container {
            flex-grow: 1;
            overflow-y: scroll;
            padding-right: 5px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        .message-user, .message-ai {
            padding: 10px;
            border-radius: 15px;
            max-width: 75%;
            margin-bottom: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            font-size: 14px;
        }
        .message-user {
            background-color: #e6f7ff; /* Light iOS blue */
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message-ai {
            background-color: #f9f9f9;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        /* Flexãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .flex-container {
            display: flex;
            align-items: center;
        }
        .flex-col {
            display: flex;
            flex-direction: column;
        }
        .flex-grow {
            flex-grow: 1;
        }
        .justify-between {
            justify-content: space-between;
        }
        .justify-end {
            justify-content: flex-end;
        }
        .align-start {
            align-items: flex-start;
        }
        .mt-4 { margin-top: 15px; }
        .mb-4 { margin-bottom: 15px; }
        .mr-2 { margin-right: 8px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .font-bold { font-weight: bold; }
        .truncate { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 100%; /* è¦ªè¦ç´ å†…ã§çœç•¥ã•ã‚Œã‚‹ã‚ˆã†ã« */
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #chat-form {
            display: flex;
            margin-top: 10px;
        }
        #chat-prompt {
            flex-grow: 1;
            margin-right: 10px;
            max-height: 100px;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰ */
        .message-box {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            color: white;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.error { background-color: #d9534f; }
        .message-box.success { background-color: #5cb85c; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="flex-col min-h-screen">

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <header class="card">
            <h1 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px;">GemAI</h1>
            <nav id="nav-tabs" class="flex-container">
                <button data-tab="home" class="tab-button tab-active">
                    ğŸ  ãƒ›ãƒ¼ãƒ 
                </button>
                <button data-tab="chat" class="tab-button">
                    ğŸ’¬ ä¼šè©±
                </button>
                <button data-tab="history" class="tab-button">
                    ğŸ“œ å±¥æ­´ (<span id="history-count">0</span>)
                </button>
                <button data-tab="gems" class="tab-button">
                    ğŸ’ Gem (<span id="gems-count">0</span>)
                </button>
                <button data-tab="settings" class="tab-button">
                    âš™ï¸ è¨­å®š
                </button>
            </nav>
        </header>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <main id="app-content" class="flex-grow flex-col" style="display: flex;"></main>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="modal-container" class="modal-container">
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JSã§å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>

    <!-- JavaScriptã‚³ãƒ¼ãƒ‰ -->
    <script>
        // --- å®šæ•° ---
        const DB_NAME = 'GemAIDB';
        const DB_VERSION = 1;
        const STORE_CHATS = 'chats';
        const STORE_GEMS = 'gems';
        const STORE_SETTINGS = 'settings';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';

        // --- IndexedDB Helper Functions ---
        async function openDB() {
            return new Promise((resolve, reject) => {
                if (window.indexedDB) {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_CHATS)) {
                            db.createObjectStore(STORE_CHATS, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(STORE_GEMS)) {
                            db.createObjectStore(STORE_GEMS, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                            db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                        }
                    };

                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };

                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject("IndexedDBã®ã‚ªãƒ¼ãƒ—ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    };
                } else {
                    reject("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯IndexedDBã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
                }
            });
        }

        async function saveToDB(storeName, data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function getFromDB(storeName, key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function getAllFromDB(storeName) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function deleteFromDB(storeName, key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // --- Global State Management ---
        const initialAppState = {
            currentTab: 'home',
            chats: [], // { id: string, name: string, isGemChat: boolean, gemId?: string, history: [{role: 'user'|'model', text: string}] }
            gems: [],  // { id: string, name: string, content: string }
            currentChatId: null,
            apiKey: '',
            isLoading: false,
            message: null, // {type: 'success'|'error', text: string}
        };

        const appState = new Proxy(initialAppState, {
            set(target, property, value) {
                target[property] = value;
                // ç‰¹å®šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å¤‰æ›´æ™‚ã«UIã‚’æ›´æ–°
                if (['currentTab', 'currentChatId', 'isLoading', 'message'].includes(property)) {
                    renderApp();
                }
                if (['chats', 'gems', 'apiKey'].includes(property)) {
                    renderApp(); // å…¨ä½“å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                }
                if (property === 'chats' || property === 'gems') {
                    // ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°
                    document.getElementById('history-count').textContent = target.chats.length;
                    document.getElementById('gems-count').textContent = target.gems.length;
                }
                return true;
            }
        });

        // --- Utility Functions ---

        function generateUniqueId() {
            return 'chat-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        }

        function showMessage(type, text) {
            appState.message = { type, text };
            setTimeout(() => appState.message = null, 3000);
        }

        // --- Gemini API Handler ---

        async function callGeminiAPI(history, systemInstruction = null) {
            if (!appState.apiKey) {
                showMessage('error', 'è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return null;
            }

            appState.isLoading = true;
            let responseData = null;
            const apiKey = appState.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
            const MAX_RETRIES = 5;

            const contents = history.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));

            let payload = {
                contents: contents,
            };

            // systemInstructionãŒnullã¾ãŸã¯ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯å«ã‚ãªã„
            if (systemInstruction && systemInstruction.trim() !== "") {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        const errorMessage = errorBody.error?.message || response.statusText;
                        
                        // APIã‚­ãƒ¼ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ã‚’å³åº§ã«æ¤œå‡º
                        if (response.status === 400 && errorMessage.includes("API key not valid")) {
                            throw new Error(`APIã‚¨ãƒ©ãƒ¼: 400 - APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                        }
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorMessage}`);
                    }

                    responseData = await response.json();
                    break; // æˆåŠŸ
                } catch (error) {
                    console.error(`APIã‚³ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${i + 1}/${MAX_RETRIES}):`, error);
                    
                    // APIã‚­ãƒ¼ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã™ãã«ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    if (error.message.includes("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™")) {
                        showMessage('error', error.message);
                        appState.isLoading = false;
                        return null;
                    }
                    
                    if (i === MAX_RETRIES - 1) {
                        showMessage('error', `AIã‹ã‚‰ã®å¿œç­”å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                        return null;
                    }
                    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            appState.isLoading = false;

            const text = responseData?.candidates?.[0]?.content?.parts?.[0]?.text || 'å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            return text;
        }

        async function callSingleTurnAPI(prompt, systemInstruction = null) {
            if (!appState.apiKey) {
                showMessage('error', 'è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return null;
            }

            let responseData = null;
            const apiKey = appState.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
            const MAX_RETRIES = 5;

            let payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            if (systemInstruction && systemInstruction.trim() !== "") {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        const errorMessage = errorBody.error?.message || response.statusText;
                        
                        // APIã‚­ãƒ¼ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ã‚’å³åº§ã«æ¤œå‡º
                        if (response.status === 400 && errorMessage.includes("API key not valid")) {
                            throw new Error(`APIã‚¨ãƒ©ãƒ¼: 400 - APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                        }
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorMessage}`);
                    }

                    responseData = await response.json();
                    break;
                } catch (error) {
                    console.error(`APIã‚³ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${i + 1}/${MAX_RETRIES}):`, error);

                    // APIã‚­ãƒ¼ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã™ãã«ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    if (error.message.includes("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™")) {
                        showMessage('error', error.message);
                        return null;
                    }

                    if (i === MAX_RETRIES - 1) {
                        showMessage('error', `AIã‹ã‚‰ã®å¿œç­”å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                        return null;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            return responseData?.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }
        
        // --- LLM Feature Implementations ---

        async function summarizeText(text) {
            if (!appState.apiKey) {
                showMessage('error', 'è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const prompt = `ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã«çµã£ã¦3ã€œ4è¡Œã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚:\n\n---\n\n${text}`;
            
            appState.isLoading = true;
            const summary = await callSingleTurnAPI(prompt);
            appState.isLoading = false;

            if (summary) {
                showModal(`
                    <div class="modal-content card">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">âœ¨ è¦ç´„çµæœ</h3>
                        <p style="white-space: pre-wrap; word-wrap: break-word; color: #333;">${summary}</p>
                        <div class="flex-container justify-end mt-4">
                            <button onclick="closeModal()" class="button secondary">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                `);
            }
        }
        
        async function generateFollowUpQuestions(currentChatHistory) {
            if (!appState.apiKey) {
                showMessage('error', 'è¨­å®šã‚¿ãƒ–ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const conversationSnippet = currentChatHistory.slice(-5).map(m => `${m.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'AI'}: ${m.text}`).join('\n');

            const systemInstruction = `ã‚ãªãŸã¯ä¼šè©±ã®å°‚é–€å®¶ã§ã™ã€‚ç›´å‰ã®ä¼šè©±ã®æ–‡è„ˆã‚’è€ƒæ…®ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã«èãå¯èƒ½æ€§ãŒæœ€ã‚‚é«˜ã„é–¢é€£è³ªå•ã‚’3ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å¿œç­”ã¯ã€è³ªå•ã®ãƒªã‚¹ãƒˆã‚’Markdownå½¢å¼ã§æä¾›ã—ã¦ãã ã•ã„ã€‚ä¾‹: "* è³ªå•1\n* è³ªå•2\n* è³ªå•3"`;
            const prompt = `ä»¥ä¸‹ã®ä¼šè©±ã®ç¶šãã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ææ¡ˆã™ã‚‹è³ªå•ã‚’3ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n---\n${conversationSnippet}`;

            appState.isLoading = true;
            const questionsRaw = await callSingleTurnAPI(prompt, systemInstruction);
            appState.isLoading = false;

            if (questionsRaw) {
                const questions = questionsRaw.split('\n')
                                            .map(line => line.replace(/^[*-]?\s*/, '').trim())
                                            .filter(line => line.length > 0);
                
                showModal(`
                    <div class="modal-content card">
                        <h3 style="font-size: 18px; font-weight: bold; color: #007aff; margin-bottom: 10px;">âœ¨ æ¬¡ã®ä¸€æ‰‹: é–¢é€£è³ªå•</h3>
                        <p style="color: #555; margin-bottom: 15px;">ä¼šè©±ã‚’æ·±ã‚ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è³ªå•ã‚’è©¦ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                        <ul style="list-style: none; padding: 0;">
                            ${questions.map(q => `
                                <li style="padding: 10px; background-color: #f0f8ff; border-radius: 4px; margin-bottom: 8px; cursor: pointer; color: #333;" onclick="selectFollowUpQuestion('${q.replace(/'/g, "\\'")}')">
                                    â–¶ï¸ ${q}
                                </li>
                            `).join('')}
                        </ul>
                        <div class="flex-container justify-end mt-4">
                            <button onclick="closeModal()" class="button secondary">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                `);
            }
        }

        // --- IndexedDB Initialization and Data Loading ---

        async function loadInitialData() {
            try {
                const [chats, gems, settings] = await Promise.all([
                    getAllFromDB(STORE_CHATS),
                    getAllFromDB(STORE_GEMS),
                    getFromDB(STORE_SETTINGS, 'apiKey')
                ]);
                appState.chats = chats.sort((a, b) => b.timestamp - a.timestamp); // æœ€æ–°é †
                appState.gems = gems;
                appState.apiKey = settings?.value || '';

                if (appState.chats.length > 0 && !appState.currentChatId) {
                    appState.currentChatId = appState.chats[0].id;
                }
                
                renderApp();
            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
                showMessage('error', 'ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                renderApp();
            }
        }

        // --- View Rendering Functions ---

        function renderApp() {
            const content = document.getElementById('app-content');
            content.innerHTML = '';
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–ã®æ›´æ–°
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.tab === appState.currentTab) {
                    btn.classList.add('tab-active');
                }
            });
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            switch (appState.currentTab) {
                case 'home':
                    renderHome(content);
                    break;
                case 'chat':
                    renderChat(content);
                    break;
                case 'history':
                    renderHistory(content);
                    break;
                case 'gems':
                    renderGems(content);
                    break;
                case 'settings':
                    renderSettings(content);
                    break;
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®æ›´æ–°
            const messageEl = document.getElementById('app-message');
            if (appState.message) {
                if (!messageEl) {
                    const msgDiv = document.createElement('div');
                    msgDiv.id = 'app-message';
                    msgDiv.className = 'message-box';
                    document.body.appendChild(msgDiv);
                }
                const msgDiv = document.getElementById('app-message');
                msgDiv.textContent = appState.message.text;
                msgDiv.className = `message-box ${appState.message.type === 'error' ? 'error' : 'success'}`;
                msgDiv.style.opacity = 1;
            } else if (messageEl) {
                messageEl.style.opacity = 0;
                // è¦ç´ ã®å‰Šé™¤ã¯è¡Œã‚ãšã€éè¡¨ç¤ºã«ã™ã‚‹ã ã‘ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªDOMæ“ä½œã‚’ç¶­æŒï¼‰
            }
        }

        function handleTabChange(event) {
            const newTab = event.currentTarget.dataset.tab;
            appState.currentTab = newTab;

            if (newTab === 'chat' && !appState.currentChatId && appState.chats.length > 0) {
                appState.currentChatId = appState.chats[0].id;
            } else if (newTab === 'chat' && appState.chats.length === 0) {
                appState.currentTab = 'home';
            }
        }
        
        // --- Tab Content Renderers ---

        function renderHome(container) {
            const isApiReady = !!appState.apiKey;

            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            container.style.textAlign = 'center';
            container.innerHTML = `
                <div class="card" style="width: 100%; max-width: 450px;">
                    <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333;">æ–°ã—ã„ä¼šè©±ã‚’å§‹ã‚ã‚‹</h2>
                    ${!isApiReady ? `
                        <div style="padding: 10px; margin-bottom: 15px; background-color: #fffbe6; border-left: 4px solid #ffc107; color: #856404; border-radius: 4px; text-align: left;">
                            <p class="font-bold">âš ï¸ APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</p>
                            <p class="text-sm">ã€Œâš™ï¸ è¨­å®šã€ã‚¿ãƒ–ã§æœ‰åŠ¹ãªGemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    ` : ''}
                    <form id="home-chat-form" style="display: flex; flex-direction: column;">
                        <textarea id="home-prompt" rows="4" placeholder="AIã«è©±ã—ã‹ã‘ã¦ãã ã•ã„..." 
                            class="input-area mb-4" required></textarea>
                        <button type="submit" class="button" ${appState.isLoading || !isApiReady ? 'disabled' : ''}>
                            ${appState.isLoading ? `
                                ğŸ”„ å‡¦ç†ä¸­...
                            ` : `
                                ğŸš€ ä¼šè©±ã‚’é–‹å§‹
                            `}
                        </button>
                    </form>
                </div>
            `;
            
            document.getElementById('home-chat-form').addEventListener('submit', handleHomeSubmit);
        }

        async function handleHomeSubmit(event) {
            event.preventDefault();
            const prompt = document.getElementById('home-prompt').value.trim();
            if (!prompt || !appState.apiKey) return;

            const newChatId = generateUniqueId();
            const initialChat = {
                id: newChatId,
                name: prompt.substring(0, 30) + (prompt.length > 30 ? '...' : ''),
                isGemChat: false,
                timestamp: Date.now(),
                history: []
            };

            appState.chats = [initialChat].concat(appState.chats);
            appState.currentChatId = newChatId;
            appState.currentTab = 'chat';

            await saveToDB(STORE_CHATS, initialChat);
            
            await handleChatSubmit(newChatId, prompt);
        }

        function renderChat(container) {
            const currentChat = appState.chats.find(c => c.id === appState.currentChatId);
            const isApiReady = !!appState.apiKey;

            if (!currentChat) {
                container.innerHTML = `
                    <div class="flex-grow flex-col flex-center" style="align-items: center; justify-content: center; text-align: center;">
                        <p style="color: #555; font-size: 16px;">ä¼šè©±ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã‹ã‚‰æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹ã‹ã€å±¥æ­´ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="appState.currentTab='home'" class="button mt-4">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                    </div>
                `;
                return;
            }

            const gem = currentChat.isGemChat ? appState.gems.find(g => g.id === currentChat.gemId) : null;
            const chatName = gem ? `[ğŸ’ ${gem.name}] ${currentChat.name}` : currentChat.name;

            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.className = 'flex-grow card';
            container.innerHTML = `
                <div class="flex-container justify-between" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <h2 style="font-size: 18px; font-weight: bold; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 70%;">${chatName}</h2>
                    <div class="flex-container">
                        <button onclick="generateFollowUpQuestions(appState.chats.find(c => c.id === appState.currentChatId).history)" 
                                style="font-size: 18px; border: none; background: none; cursor: pointer; color: #ff9800;" 
                                title="æ¬¡ã«èãè³ªå•ã‚’ææ¡ˆ" ${!isApiReady ? 'disabled' : ''}>
                            âœ¨
                        </button>
                        <button id="rename-chat-btn" style="font-size: 18px; border: none; background: none; cursor: pointer; color: #555;" title="ä¼šè©±åã‚’å¤‰æ›´">
                            âœï¸
                        </button>
                    </div>
                </div>

                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="messages-container" class="flex-grow" style="overflow-y: auto; padding-right: 5px;">
                    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§æŒ¿å…¥ -->
                </div>
                
                <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                ${!isApiReady ? `
                    <div style="padding: 10px; margin-top: 10px; background-color: #ffebee; border-left: 4px solid #f44336; color: #c62828; border-radius: 4px;">
                        <p class="font-bold">ğŸš« APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™</p>
                        <p class="text-sm">ãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚</p>
                    </div>
                ` : ''}
                <form id="chat-form" class="flex-container" style="margin-top: 10px;">
                    <textarea id="chat-prompt" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
                        class="input-area flex-grow" required></textarea>
                    <button type="submit" class="button" style="width: 80px; margin-left: 10px;" ${appState.isLoading || !isApiReady ? 'disabled' : ''}>
                        ${appState.isLoading ? `
                            â³
                        ` : `
                            â¡ï¸ é€ä¿¡
                        `}
                    </button>
                </form>
            `;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const messagesContainer = document.getElementById('messages-container');
            currentChat.history.forEach((msg, index) => {
                const isAI = msg.role === 'model';
                const messageEl = document.createElement('div');
                messageEl.className = `flex-container ${isAI ? 'justify-start' : 'justify-end'}`;
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
                const contentDiv = document.createElement('div');
                contentDiv.className = isAI ? 'message-ai' : 'message-user';
                contentDiv.innerHTML = msg.text.replace(/\n/g, '<br>');

                messageEl.appendChild(contentDiv);

                // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                if (isAI) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex-container justify-end'
                    actionsDiv.style.marginTop = '5px';
                    actionsDiv.style.fontSize = '12px';

                    const summaryBtn = document.createElement('button');
                    summaryBtn.textContent = 'âœ¨ è¦ç´„';
                    summaryBtn.className = 'action-link';
                    summaryBtn.title = 'AIã®å¿œç­”ã‚’è¦ç´„';
                    summaryBtn.onclick = function() { summarizeText(msg.text); };
                    summaryBtn.disabled = !isApiReady;
                    contentDiv.appendChild(summaryBtn);
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    copyBtn.className = 'action-link';
                    copyBtn.title = 'ã‚³ãƒ”ãƒ¼';
                    copyBtn.onclick = function() { copyResponse(msg.text); };
                    contentDiv.appendChild(copyBtn);
                    
                    const shareBtn = document.createElement('button');
                    shareBtn.textContent = 'ğŸ“¤ å…±æœ‰';
                    shareBtn.className = 'action-link';
                    shareBtn.title = 'å…±æœ‰';
                    shareBtn.onclick = function() { shareResponse(msg.text); };
                    contentDiv.appendChild(shareBtn);
                }
                
                messagesContainer.appendChild(messageEl);
            });

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            if (isApiReady) {
                document.getElementById('chat-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const prompt = document.getElementById('chat-prompt').value.trim();
                    document.getElementById('chat-prompt').value = '';
                    if (prompt) handleChatSubmit(currentChat.id, prompt, gem?.content);
                });
            }
            
            document.getElementById('rename-chat-btn').addEventListener('click', () => showRenameModal(currentChat));

            // textareaã®è‡ªå‹•é«˜ã•èª¿æ•´
            const textarea = document.getElementById('chat-prompt');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            });
            textarea.dispatchEvent(new Event('input')); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€åº¦å®Ÿè¡Œ
        }
        
        function selectFollowUpQuestion(question) {
            const textarea = document.getElementById('chat-prompt');
            if (textarea) {
                textarea.value = question;
                textarea.focus();
                textarea.dispatchEvent(new Event('input')); // é«˜ã•èª¿æ•´ã‚’ãƒˆãƒªã‚¬ãƒ¼
                closeModal();
            }
        }

        function showRenameModal(chat) {
            const modalContent = `
                <div class="modal-content card">
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ä¼šè©±åã®å¤‰æ›´</h3>
                    <input type="text" id="new-chat-name" class="input-area mb-4" value="${chat.name}">
                    <div class="flex-container justify-end">
                        <button onclick="closeModal()" class="button secondary" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="confirm-rename-btn" class="button">å¤‰æ›´</button>
                    </div>
                </div>
            `;
            showModal(modalContent);

            document.getElementById('confirm-rename-btn').addEventListener('click', async () => {
                const newName = document.getElementById('new-chat-name').value.trim();
                if (newName && newName !== chat.name) {
                    chat.name = newName;
                    await saveChat(chat);
                    appState.chats = [].concat(appState.chats); // UIæ›´æ–°ã®ãŸã‚ã«çŠ¶æ…‹ã‚’ãƒˆãƒªã‚¬ãƒ¼
                    closeModal();
                    showMessage('success', 'ä¼šè©±åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚');
                } else {
                    closeModal();
                }
            });
        }

        async function handleChatSubmit(chatId, prompt, gemContent = null) {
            const currentChatIndex = appState.chats.findIndex(c => c.id === chatId);
            if (currentChatIndex === -1 || !appState.apiKey) return;

            const chat = appState.chats[currentChatIndex];
            
            const userMessage = { role: 'user', text: prompt };
            chat.history.push(userMessage);
            
            appState.chats = [].concat(appState.chats);
            
            const aiResponse = await callGeminiAPI(chat.history, gemContent);

            if (aiResponse) {
                const aiMessage = { role: 'model', text: aiResponse };
                chat.history.push(aiMessage);
                chat.timestamp = Date.now();
                
                // å±¥æ­´ã‚¿ãƒ–ã®é †åºã‚’ä¿®æ­£ã—ã¦UIã‚’æ›´æ–°
                appState.chats.splice(currentChatIndex, 1);
                appState.chats = [chat].concat(appState.chats);

                await saveChat(chat);
            }
        }

        function copyResponse(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                // execCommandã¯å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚å‹•ä½œã™ã‚‹ãŒã€éæ¨å¥¨ã€‚iOS 10ã§ã¯å¿…è¦ã€‚
                const successful = document.execCommand('copy'); 
                showMessage('success', successful ? 'å›ç­”ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚' : 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } catch (err) {
                showMessage('error', 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            document.body.removeChild(textarea);
        }

        function shareResponse(text) {
            // navigator.shareã¯iOS 10ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã€ã‚³ãƒ”ãƒ¼ã‚’ä»£æ›¿ã¨ã™ã‚‹
            if (navigator.share) {
                navigator.share({
                    title: 'GemAIã‹ã‚‰ã®å›ç­”',
                    text: text,
                }).then(() => {
                    showMessage('success', 'å›ç­”ã‚’å…±æœ‰ã—ã¾ã—ãŸã€‚');
                }).catch((error) => {
                    if (error.name !== 'AbortError') {
                        copyResponse(text); // å…±æœ‰å¤±æ•—æ™‚ã¯ã‚³ãƒ”ãƒ¼ã‚’è©¦ã¿ã‚‹
                        showMessage('error', 'å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
                    }
                });
            } else {
                copyResponse(text);
                showMessage('error', 'å…±æœ‰æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
            }
        }

        async function saveChat(chat) {
            try {
                await saveToDB(STORE_CHATS, chat);
            } catch (e) {
                console.error("ãƒãƒ£ãƒƒãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
                showMessage('error', 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }


        function renderHistory(container) {
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.className = 'flex-grow card';
            container.innerHTML = `
                <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333;">ğŸ“œ ä¼šè©±å±¥æ­´</h2>
                <div id="history-list" class="flex-col" style="flex-grow: 1; overflow-y: auto;">
                    ${appState.chats.length === 0 
                        ? '<p style="color: #555;">ä¿å­˜ã•ã‚ŒãŸä¼šè©±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' 
                        : appState.chats.map(chat => {
                            const date = new Date(chat.timestamp).toLocaleDateString('ja-JP', { day: '2-digit', month: '2-digit' });
                            const time = new Date(chat.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                            const isSelected = chat.id === appState.currentChatId;
                            const gemLabel = chat.isGemChat ? `<span style="font-size: 11px; color: #8a2be2; font-weight: bold; margin-left: 5px;">(ğŸ’ ${appState.gems.find(g => g.id === chat.gemId)?.name || 'ã‚«ã‚¹ã‚¿ãƒ '})</span>` : '';
                            
                            return `
                                <div id="history-item-${chat.id}" 
                                     class="card flex-container justify-between"
                                     style="padding: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid ${isSelected ? '#007aff' : '#eee'};"
                                     onclick="loadChat('${chat.id}')">
                                    <div style="overflow: hidden; flex-grow: 1; margin-right: 10px;">
                                        <p class="font-bold truncate" style="color: #333;">${chat.name} ${gemLabel}</p>
                                        <p class="text-sm" style="color: #888;">${date} ${time}</p>
                                    </div>
                                    <div class="flex-container">
                                        <button onclick="event.stopPropagation(); showRenameModal(appState.chats.find(c => c.id === '${chat.id}'))" 
                                                style="font-size: 18px; border: none; background: none; cursor: pointer; color: #007aff; padding: 5px;" title="åå‰å¤‰æ›´">
                                            âœï¸
                                        </button>
                                        <button onclick="event.stopPropagation(); showDeleteChatModal('${chat.id}')" 
                                                style="font-size: 18px; border: none; background: none; cursor: pointer; color: #ff3b30; padding: 5px;" title="å‰Šé™¤">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
        }

        function loadChat(chatId) {
            appState.currentChatId = chatId;
            appState.currentTab = 'chat';
        }

        function showDeleteChatModal(chatId) {
            const chat = appState.chats.find(c => c.id === chatId);
            if (!chat) return;

            const modalContent = `
                <div class="modal-content card">
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #ff3b30;">ğŸ—‘ï¸ ä¼šè©±ã®å‰Šé™¤</h3>
                    <p style="margin-bottom: 15px;">æœ¬å½“ã«ä»¥ä¸‹ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                    <p class="font-bold truncate" style="color: #333; margin-bottom: 15px;">${chat.name}</p>
                    <div class="flex-container justify-end">
                        <button onclick="closeModal()" class="button secondary" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="confirm-delete-chat-btn" data-chat-id="${chatId}" class="button" style="background-color: #ff3b30;">å‰Šé™¤</button>
                    </div>
                </div>
            `;
            showModal(modalContent);

            document.getElementById('confirm-delete-chat-btn').addEventListener('click', async (e) => {
                const id = e.target.dataset.chatId;
                await deleteChat(id);
                closeModal();
            });
        }

        async function deleteChat(chatId) {
            try {
                await deleteFromDB(STORE_CHATS, chatId);
                appState.chats = appState.chats.filter(c => c.id !== chatId);

                if (appState.currentChatId === chatId) {
                    appState.currentChatId = appState.chats.length > 0 ? appState.chats[0].id : null;
                }
                showMessage('success', 'ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error("ãƒãƒ£ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
                showMessage('error', 'ä¼šè©±ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        function renderGems(container) {
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.className = 'flex-grow card';
            container.innerHTML = `
                <h2 style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px;">ğŸ’ ã‚«ã‚¹ã‚¿ãƒ Gemã®ç®¡ç†</h2>
                
                <!-- Gemãƒªã‚¹ãƒˆ -->
                <div id="gems-list" style="flex-grow: 1; overflow-y: auto;">
                    ${appState.gems.length === 0 
                        ? '<p style="color: #555;">ã‚«ã‚¹ã‚¿ãƒ Gemã¯ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>' 
                        : appState.gems.map(gem => `
                            <div class="card" style="padding: 10px; margin-bottom: 8px;">
                                <div class="flex-container justify-between" style="align-items: flex-start;">
                                    <div style="overflow: hidden; flex-grow: 1; margin-right: 10px;">
                                        <p class="font-bold" style="color: #333; margin-bottom: 5px; cursor: pointer;" onclick="startGemChat('${gem.id}')">
                                            ğŸ’ ${gem.name}
                                        </p>
                                        <p class="text-sm" style="color: #888; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${gem.content}</p>
                                    </div>
                                    <div class="flex-container">
                                        <button onclick="showEditGemModal('${gem.id}')" 
                                                style="font-size: 18px; border: none; background: none; cursor: pointer; color: #007aff; padding: 5px;" title="ç·¨é›†">
                                            âœï¸
                                        </button>
                                        <button onclick="showDeleteGemModal('${gem.id}')" 
                                                style="font-size: 18px; border: none; background: none; cursor: pointer; color: #ff3b30; padding: 5px;" title="å‰Šé™¤">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>

                <!-- æ–°è¦Gemä½œæˆãƒœã‚¿ãƒ³ -->
                <button onclick="showCreateGemModal()" class="button mt-4">
                    â• æ–°ã—ã„Gemã‚’ä½œæˆ
                </button>
            `;
        }
        
        function showCreateGemModal(gemToEdit = null) {
            const isEdit = !!gemToEdit;
            const modalContent = `
                <div class="modal-content card" style="max-width: 500px;">
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">${isEdit ? 'Gemã®ç·¨é›†' : 'æ–°ã—ã„Gemã‚’ä½œæˆ'}</h3>
                    <form id="gem-form" data-gem-id="${isEdit ? gemToEdit.id : ''}">
                        <div style="margin-bottom: 15px;">
                            <label for="gem-name" style="display: block; font-size: 14px; color: #555; margin-bottom: 5px;">Gemå (ä¾‹: å°‚é–€ã®ã‚·ã‚§ãƒ•)</label>
                            <input type="text" id="gem-name" class="input-area" value="${isEdit ? gemToEdit.name : ''}" required>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label for="gem-content" style="display: block; font-size: 14px; color: #555; margin-bottom: 5px;">Gemã®å†…å®¹ (ã‚·ã‚¹ãƒ†ãƒ å‘½ä»¤)</label>
                            <textarea id="gem-content" rows="5" placeholder="ä¾‹: ã‚ãªãŸã¯ã€ä¸–ç•Œä¸­ã®æ–™ç†ã«ç²¾é€šã—ãŸãƒ¦ãƒ¼ãƒ¢ã‚¢ã®ã‚ã‚‹å°‚é–€ã®ã‚·ã‚§ãƒ•ã§ã™..." 
                                class="input-area" required>${isEdit ? gemToEdit.content : ''}</textarea>
                        </div>
                        <div class="flex-container justify-end">
                            <button type="button" onclick="closeModal()" class="button secondary" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="button">${isEdit ? 'æ›´æ–°' : 'ä½œæˆ'}</button>
                        </div>
                    </form>
                </div>
            `;
            showModal(modalContent);
            document.getElementById('gem-form').addEventListener('submit', handleGemSubmit);
        }

        function showEditGemModal(gemId) {
            const gem = appState.gems.find(g => g.id === gemId);
            if (gem) showCreateGemModal(gem);
        }

        async function handleGemSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const gemId = form.dataset.gemId;
            const name = document.getElementById('gem-name').value.trim();
            const content = document.getElementById('gem-content').value.trim();

            if (!name || !content) return;

            if (gemId) {
                const gem = appState.gems.find(g => g.id === gemId);
                if (gem) {
                    gem.name = name;
                    gem.content = content;
                    await saveToDB(STORE_GEMS, gem);
                    appState.gems = [].concat(appState.gems);
                    showMessage('success', 'Gemã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
                }
            } else {
                const newGem = {
                    id: generateUniqueId(),
                    name: name,
                    content: content
                };
                await saveToDB(STORE_GEMS, newGem);
                appState.gems = [newGem].concat(appState.gems);
                showMessage('success', 'æ–°ã—ã„Gemã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
            }

            closeModal();
        }

        function showDeleteGemModal(gemId) {
            const gem = appState.gems.find(g => g.id === gemId);
            if (!gem) return;

            const modalContent = `
                <div class="modal-content card">
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #ff3b30;">ğŸ—‘ï¸ Gemã®å‰Šé™¤</h3>
                    <p style="margin-bottom: 15px;">æœ¬å½“ã«Gemã€Œ${gem.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                    <div class="flex-container justify-end">
                        <button onclick="closeModal()" class="button secondary" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="confirm-delete-gem-btn" data-gem-id="${gemId}" class="button" style="background-color: #ff3b30;">å‰Šé™¤</button>
                    </div>
                </div>
            `;
            showModal(modalContent);

            document.getElementById('confirm-delete-gem-btn').addEventListener('click', async (e) => {
                const id = e.target.dataset.gemId;
                await deleteGem(id);
                closeModal();
            });
        }

        async function deleteGem(gemId) {
            try {
                await deleteFromDB(STORE_GEMS, gemId);
                appState.gems = appState.gems.filter(g => g.id !== gemId);
                showMessage('success', 'Gemã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error("Gemå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
                showMessage('error', 'Gemã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        function startGemChat(gemId) {
            const gem = appState.gems.find(g => g.id === gemId);
            if (!gem || !appState.apiKey) {
                showMessage('error', 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€Gemã¨ã®ä¼šè©±ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            const modalContent = `
                <div class="modal-content card" style="max-width: 500px;">
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">ğŸ’ Gemã€Œ${gem.name}ã€ã¨ã®ä¼šè©±é–‹å§‹</h3>
                    <p style="color: #555; margin-bottom: 10px;">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIã¯ä»¥ä¸‹ã®ãƒšãƒ«ã‚½ãƒŠã«å¾“ã„ã¾ã™:</p>
                    <div style="padding: 10px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 15px; font-size: 13px; color: #444; max-height: 80px; overflow-y: auto;">${gem.content}</div>
                    <form id="start-gem-chat-form" data-gem-id="${gem.id}">
                        <textarea id="gem-initial-prompt" rows="3" placeholder="æœ€åˆã®è³ªå•ã‚„æŒ¨æ‹¶ã‚’å…¥åŠ›..." 
                            class="input-area" required></textarea>
                        <div class="flex-container justify-end mt-4">
                            <button type="button" onclick="closeModal()" class="button secondary" style="margin-right: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="button">ä¼šè©±é–‹å§‹</button>
                        </div>
                    </form>
                </div>
            `;
            showModal(modalContent);
            document.getElementById('start-gem-chat-form').addEventListener('submit', handleStartGemChatSubmit);
        }

        async function handleStartGemChatSubmit(event) {
            event.preventDefault();
            closeModal();
            
            const gemId = event.target.dataset.gemId;
            const prompt = document.getElementById('gem-initial-prompt').value.trim();
            const gem = appState.gems.find(g => g.id === gemId);
            if (!prompt || !gem || !appState.apiKey) return;

            const newChatId = generateUniqueId();
            const initialChat = {
                id: newChatId,
                name: prompt.substring(0, 30) + (prompt.length > 30 ? '...' : ''),
                isGemChat: true,
                gemId: gemId,
                timestamp: Date.now(),
                history: []
            };

            appState.chats = [initialChat].concat(appState.chats);
            appState.currentChatId = newChatId;
            appState.currentTab = 'chat';

            await saveToDB(STORE_CHATS, initialChat);
            
            await handleChatSubmit(newChatId, prompt, gem.content);
        }

        function renderSettings(container) {
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.className = 'flex-grow card';
            container.innerHTML = `
                <h2 style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px;">âš™ï¸ è¨­å®š</h2>
                
                <!-- APIã‚­ãƒ¼è¨­å®š -->
                <div style="padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px;">
                    <h3 style="font-size: 18px; font-weight: bold; color: #555; margin-bottom: 10px;">Gemini APIã‚­ãƒ¼</h3>
                    <form id="api-key-form">
                        <input type="password" id="api-key-input" placeholder="ã‚ãªãŸã®Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›" 
                            class="input-area mb-4" value="${appState.apiKey}">
                        <button type="submit" class="button">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
                    </form>
                    <p class="text-sm" style="color: #888; margin-top: 10px;">APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                <div>
                    <h3 style="font-size: 18px; font-weight: bold; color: #555; margin-bottom: 10px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="export-btn" class="button secondary flex-grow">
                            â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <div style="position: relative; flex-grow: 1;">
                            <input type="file" id="import-file" accept=".json" style="position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;" onchange="handleImport(event)">
                            <button class="button secondary" style="width: 100%;">
                                â¬†ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('api-key-form').addEventListener('submit', handleApiKeySubmit);
            document.getElementById('export-btn').addEventListener('click', handleExport);
        }

        async function handleApiKeySubmit(event) {
            event.preventDefault();
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                appState.apiKey = apiKey;
                await saveToDB(STORE_SETTINGS, { key: 'apiKey', value: apiKey });
                showMessage('success', 'APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } else {
                appState.apiKey = '';
                await saveToDB(STORE_SETTINGS, { key: 'apiKey', value: '' });
                showMessage('success', 'APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
            }
        }

        async function handleExport() {
            try {
                const [chats, gems] = await Promise.all([
                    getAllFromDB(STORE_CHATS),
                    getAllFromDB(STORE_GEMS)
                ]);

                const exportData = {
                    version: DB_VERSION,
                    timestamp: Date.now(),
                    chats: chats,
                    gems: gems
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `GemAI_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('success', 'ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');

            } catch (e) {
                console.error("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", e);
                showMessage('error', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const fileContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
                
                const importData = JSON.parse(fileContent);

                if (!importData.chats || !importData.gems || importData.version !== DB_VERSION) {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ããªã„ã‹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                }

                const db = await openDB();
                const transaction = db.transaction([STORE_CHATS, STORE_GEMS], 'readwrite');
                const chatStore = transaction.objectStore(STORE_CHATS);
                const gemStore = transaction.objectStore(STORE_GEMS);

                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                chatStore.clear();
                gemStore.clear();

                importData.chats.forEach(chat => chatStore.put(chat));
                importData.gems.forEach(gem => gemStore.put(gem));

                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = reject;
                });

                // ã‚¢ãƒ—ãƒªçŠ¶æ…‹ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                await loadInitialData();
                showMessage('success', 'ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');

            } catch (e) {
                console.error("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", e);
                showMessage('error', `ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message || 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'}`);
            }
        }

        // --- Modal Helper ---
        function showModal(contentHTML) {
            const container = document.getElementById('modal-container');
            container.innerHTML = contentHTML;
            container.style.display = 'flex';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            container.onclick = (e) => {
                if (e.target === container) {
                    closeModal();
                }
            };
        }

        function closeModal() {
            const container = document.getElementById('modal-container');
            container.style.display = 'none';
            container.innerHTML = '';
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', handleTabChange);
            });

            // IndexedDBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¢ãƒ—ãƒªã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            loadInitialData();
        });
    </script>
</body>
</html>
