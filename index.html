<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GemAI for OLD devices</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
/* --- Material You Variables (User Provided + Extensions) --- */
/* 青テーマ (Default) */
:root {
    --md-sys-color-primary-light: #0061a4;
    --md-sys-color-on-primary-light: #ffffff;
    --md-sys-color-primary-container-light: #d0e4ff;
    --md-sys-color-on-primary-container-light: #001d36;
    --md-sys-color-background-light: #fdfcff;
    --md-sys-color-on-background-light: #1a1c1e;
    --md-sys-color-surface-light: #fdfcff;
    --md-sys-color-on-surface-light: #1a1c1e;
    --md-sys-color-surface-variant-light: #dfe2eb;
    --md-sys-color-on-surface-variant-light: #43474e;
    --md-sys-color-outline-light: #73777f;
    --md-sys-color-error-light: #ba1a1a;
    --md-sys-color-on-error-light: #ffffff;

    --md-sys-color-primary-dark: #9fcbff;
    --md-sys-color-on-primary-dark: #003258;
    --md-sys-color-primary-container-dark: #00497d;
    --md-sys-color-on-primary-container-dark: #d0e4ff;
    --md-sys-color-background-dark: #1a1c1e;
    --md-sys-color-on-background-dark: #e3e2e6;
    --md-sys-color-surface-dark: #1a1c1e;
    --md-sys-color-on-surface-dark: #e3e2e6;
    --md-sys-color-surface-variant-dark: #43474e;
    --md-sys-color-on-surface-variant-dark: #c3c6cf;
    --md-sys-color-outline-dark: #8d9199;
    --md-sys-color-error-dark: #ffb4ab;
    --md-sys-color-on-error-dark: #690005;
}

/* 青緑テーマ */
.theme-teal {
    --md-sys-color-primary-light: #006a60;
    --md-sys-color-on-primary-light: #ffffff;
    --md-sys-color-primary-container-light: #6ff7e4;
    --md-sys-color-on-primary-container-light: #00201d;
    --md-sys-color-primary-dark: #4fdcc8;
    --md-sys-color-on-primary-dark: #003732;
    --md-sys-color-primary-container-dark: #005049;
    --md-sys-color-on-primary-container-dark: #6ff7e4;
}

/* 紫テーマ */
.theme-purple {
    --md-sys-color-primary-light: #7b4f9f;
    --md-sys-color-on-primary-light: #ffffff;
    --md-sys-color-primary-container-light: #f0dbff;
    --md-sys-color-on-primary-container-light: #2d0050;
    --md-sys-color-primary-dark: #f0dbff;
    --md-sys-color-on-primary-dark: #471e6d;
    --md-sys-color-primary-container-dark: #613685;
    --md-sys-color-on-primary-container-dark: #f0dbff;
}

/* Theme Mapping */
:root, .light-mode {
    --md-sys-color-primary: var(--md-sys-color-primary-light);
    --md-sys-color-on-primary: var(--md-sys-color-on-primary-light);
    --md-sys-color-primary-container: var(--md-sys-color-primary-container-light);
    --md-sys-color-on-primary-container: var(--md-sys-color-on-primary-container-light);
    --md-sys-color-background: var(--md-sys-color-background-light);
    --md-sys-color-on-background: var(--md-sys-color-on-background-light);
    --md-sys-color-surface: var(--md-sys-color-surface-light);
    --md-sys-color-on-surface: var(--md-sys-color-on-surface-light);
    --md-sys-color-surface-variant: var(--md-sys-color-surface-variant-light);
    --md-sys-color-on-surface-variant: var(--md-sys-color-on-surface-variant-light);
    --md-sys-color-outline: var(--md-sys-color-outline-light);
    --md-sys-color-error: var(--md-sys-color-error-light);
    --md-sys-color-on-error: var(--md-sys-color-on-error-light);
}

.dark-mode {
    --md-sys-color-primary: var(--md-sys-color-primary-dark);
    --md-sys-color-on-primary: var(--md-sys-color-on-primary-dark);
    --md-sys-color-primary-container: var(--md-sys-color-primary-container-dark);
    --md-sys-color-on-primary-container: var(--md-sys-color-on-primary-container-dark);
    --md-sys-color-background: var(--md-sys-color-background-dark);
    --md-sys-color-on-background: var(--md-sys-color-on-background-dark);
    --md-sys-color-surface: var(--md-sys-color-surface-dark);
    --md-sys-color-on-surface: var(--md-sys-color-on-surface-dark);
    --md-sys-color-surface-variant: var(--md-sys-color-surface-variant-dark);
    --md-sys-color-on-surface-variant: var(--md-sys-color-on-surface-variant-dark);
    --md-sys-color-outline: var(--md-sys-color-outline-dark);
    --md-sys-color-error: var(--md-sys-color-error-dark);
    --md-sys-color-on-error: var(--md-sys-color-on-error-dark);
}

/* --- Base Styles --- */
body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding-bottom: 80px; /* Nav height + buffer */
    background-color: var(--md-sys-color-background);
    color: var(--md-sys-color-on-background);
    transition: background-color 0.3s, color 0.3s;
    min-height: 100vh;
    overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
}

.container {
    padding: 16px;
    max-width: 800px;
    margin: 0 auto;
    box-sizing: border-box;
}

/* --- Layout & Typography --- */
h2, h3 { margin-top: 0; font-weight: 500; }
h2 { font-size: 24px; margin-bottom: 24px; color: var(--md-sys-color-primary); }
h3 { font-size: 18px; margin-bottom: 12px; color: var(--md-sys-color-on-surface); }
p { line-height: 1.5; }

.content { display: none; animation: fadeIn 0.3s ease; }
.content.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* --- Input Fields & Buttons --- */
.text-field {
    width: 100%;
    background-color: var(--md-sys-color-surface-variant);
    border: none;
    border-radius: 8px 8px 0 0;
    border-bottom: 2px solid var(--md-sys-color-outline);
    padding: 16px;
    font-size: 16px;
    color: var(--md-sys-color-on-surface);
    box-sizing: border-box;
    margin-bottom: 16px;
    font-family: inherit;
    transition: border-color 0.2s;
}
.text-field:focus { outline: none; border-bottom-color: var(--md-sys-color-primary); }

.filled-button, .tonal-button, .icon-button {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 24px; border-radius: 20px; border: none;
    font-size: 14px; font-weight: 500; cursor: pointer;
    transition: opacity 0.2s; gap: 8px;
}
.filled-button {
    background-color: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
    width: 100%; box-sizing: border-box;
}
.tonal-button {
    background-color: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
}
.icon-button {
    padding: 8px; border-radius: 50%;
    background: transparent; color: var(--md-sys-color-on-surface-variant);
}
.filled-button:active, .tonal-button:active { opacity: 0.8; }

/* --- List Items (History & Gems) --- */
.list-item {
    background-color: var(--md-sys-color-surface);
    border: 1px solid var(--md-sys-color-outline);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s;
}
.list-item:hover { background-color: var(--md-sys-color-surface-variant); }
.list-content { flex: 1; overflow: hidden; }
.list-title { font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-subtitle { font-size: 12px; color: var(--md-sys-color-outline); }
.list-actions { display: flex; gap: 4px; }

/* --- Chat Interface --- */
.chat-container {
    display: flex; flex-direction: column; height: calc(100vh - 140px);
}
.chat-history-view {
    flex: 1; overflow-y: auto; padding-bottom: 16px;
    display: flex; flex-direction: column; gap: 12px;
}
.message-bubble {
    max-width: 80%; padding: 12px 16px; border-radius: 16px;
    line-height: 1.5; position: relative; word-wrap: break-word;
}
.message-user {
    align-self: flex-end;
    background-color: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
    border-bottom-right-radius: 4px;
}
.message-ai {
    align-self: flex-start;
    background-color: var(--md-sys-color-surface-variant);
    color: var(--md-sys-color-on-surface-variant);
    border-bottom-left-radius: 4px;
}
.message-actions {
    display: flex; justify-content: flex-end; gap: 8px; margin-top: 4px;
}
.message-action-btn {
    font-size: 16px; padding: 4px; color: inherit; opacity: 0.7; cursor: pointer;
}
.chat-input-area {
    display: flex; gap: 8px; padding-top: 8px;
    background-color: var(--md-sys-color-background);
}
.chat-input-area .text-field { margin-bottom: 0; border-radius: 24px; padding: 12px 20px; }

/* --- FAB (Floating Action Button) --- */
.fab {
    position: fixed; bottom: 80px; right: 16px;
    width: 56px; height: 56px; border-radius: 16px;
    background-color: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; border: none;
    z-index: 10;
}

/* --- Settings Styles --- */
.setting-section {
    background-color: var(--md-sys-color-surface-variant);
    border-radius: 12px; padding: 16px; margin-bottom: 16px;
}
.setting-item {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
}
.setting-item:last-child { margin-bottom: 0; }
.switch { position: relative; display: inline-block; width: 52px; height: 32px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--md-sys-color-outline); transition: .4s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px;
    background-color: #fff; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--md-sys-color-primary); }
input:checked + .slider:before { transform: translateX(20px); background-color: var(--md-sys-color-on-primary); }
.color-options { display: flex; gap: 12px; margin-top: 12px; }
.color-option {
    width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
    border: 2px solid transparent; transition: transform 0.2s;
}
.color-option.active { border-color: var(--md-sys-color-on-surface-variant); transform: scale(1.1); }

/* --- Navigation --- */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    display: flex; justify-content: space-around; align-items: center;
    height: 70px; background-color: var(--md-sys-color-surface);
    border-top: 1px solid var(--md-sys-color-outline);
    z-index: 100;
}
.nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; cursor: pointer; color: var(--md-sys-color-on-surface-variant);
    padding: 4px; border-radius: 16px; transition: all 0.2s;
}
.nav-item .icon-container {
    padding: 4px 20px; border-radius: 16px; margin-bottom: 4px;
}
.nav-item.active .icon-container {
    background-color: var(--md-sys-color-primary-container);
}
.nav-item.active { color: var(--md-sys-color-on-surface); }
.nav-item .material-symbols-outlined { font-size: 24px; }
.nav-item span { font-size: 12px; font-weight: 500; }

/* Dialog/Modal */
.dialog-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200;
}
.dialog {
    background: var(--md-sys-color-surface); padding: 24px; border-radius: 28px;
    width: 90%; max-width: 320px;
}
.dialog-title { font-size: 24px; margin-bottom: 16px; color: var(--md-sys-color-on-surface); }
.dialog-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px; }

</style>
</head>
<body class="light-mode">

<div class="container">

    <div id="home-content" class="content active">
        <h2>ようこそ、GemAIへ</h2>
        <div style="text-align: center; margin: 40px 0;">
            <span class="material-symbols-outlined" style="font-size: 64px; color: var(--md-sys-color-primary);">smart_toy</span>
        </div>
        <p>古いデバイスでも最新のAI体験を。<br>新しい会話を始めましょう。</p>
        
        <div style="margin-top: 24px;">
            <textarea id="home-input" class="text-field" rows="3" placeholder="メッセージを入力..."></textarea>
            <button id="home-send-btn" class="filled-button">
                <span class="material-symbols-outlined">send</span>
                送信して会話を開始
            </button>
        </div>
    </div>

    <div id="chat-content" class="content">
        <div class="chat-container">
            <div id="chat-messages" class="chat-history-view">
                <div style="text-align: center; color: var(--md-sys-color-outline); margin-top: 20px;">
                    会話を開始するか、履歴から選択してください。
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chat-input" class="text-field" rows="1" placeholder="返信を入力..."></textarea>
                <button id="chat-send-btn" class="icon-button" style="background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);">
                    <span class="material-symbols-outlined">send</span>
                </button>
            </div>
        </div>
    </div>

    <div id="history-content" class="content">
        <h2>会話履歴</h2>
        <div id="history-list">
            </div>
    </div>

    <div id="gem-content" class="content">
        <h2>マイ Gems</h2>
        <p style="font-size: 14px; color: var(--md-sys-color-outline);">カスタムAIキャラクターを作成・管理します。</p>
        <div id="gem-list">
            </div>
        <button id="create-gem-fab" class="fab">
            <span class="material-symbols-outlined">add</span>
        </button>
    </div>

    <div id="settings-content" class="content">
        <h2>設定</h2>
        
        <div class="setting-section">
            <h3>API設定</h3>
            <div style="margin-bottom: 8px; font-size: 12px;">Google Gemini APIキーを入力してください。</div>
            <input type="password" id="api-key-input" class="text-field" placeholder="API Key">
            <button id="save-api-key" class="tonal-button" style="margin-top:8px;">保存</button>
        </div>

        <div class="setting-section">
            <h3>データ管理</h3>
            <div class="button-group" style="display: flex; gap: 8px;">
                <button id="export-data" class="tonal-button">
                    <span class="material-symbols-outlined">download</span> エクスポート
                </button>
                <button id="import-data" class="tonal-button">
                    <span class="material-symbols-outlined">upload</span> インポート
                    <input type="file" id="import-file" style="display: none;" accept=".json">
                </button>
            </div>
        </div>

        <div class="setting-section">
            <div class="setting-item">
                <span>ダークモード</span>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="setting-section">
            <h3>カラーテーマ</h3>
            <div class="color-options">
                <div class="color-option active" style="background-color: #0061a4;" data-theme="blue"></div>
                <div class="color-option" style="background-color: #006a60;" data-theme="teal"></div>
                <div class="color-option" style="background-color: #7b4f9f;" data-theme="purple"></div>
            </div>
        </div>
    </div>

</div>

<div id="gem-dialog" class="dialog-overlay">
    <div class="dialog">
        <div class="dialog-title">Gemの作成</div>
        <input type="text" id="gem-name" class="text-field" placeholder="Gem名 (例: 英語の先生)" style="border-radius: 4px;">
        <textarea id="gem-instructions" class="text-field" rows="4" placeholder="システム指示 (例: あなたは親切な英語教師です...)" style="border-radius: 4px; margin-top: 8px;"></textarea>
        <div class="dialog-actions">
            <button id="close-gem-dialog" class="icon-button" style="color: var(--md-sys-color-primary);">キャンセル</button>
            <button id="save-gem-btn" class="filled-button" style="width: auto;">保存</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" data-target="home">
        <div class="icon-container"><span class="material-symbols-outlined">home</span></div>
        <span>ホーム</span>
    </div>
    <div class="nav-item" data-target="chat">
        <div class="icon-container"><span class="material-symbols-outlined">chat</span></div>
        <span>会話</span>
    </div>
    <div class="nav-item" data-target="history">
        <div class="icon-container"><span class="material-symbols-outlined">history</span></div>
        <span>履歴</span>
    </div>
    <div class="nav-item" data-target="gem">
        <div class="icon-container"><span class="material-symbols-outlined">diamond</span></div>
        <span>Gem</span>
    </div>
    <div class="nav-item" data-target="settings">
        <div class="icon-container"><span class="material-symbols-outlined">settings</span></div>
        <span>設定</span>
    </div>
</div>

<script>
/**
 * GemAI Core Logic
 * Uses IndexedDB for storage and basic Fetch API for Gemini
 */

// --- State Management ---
let currentChatId = null;
let db = null;
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";

// --- IndexedDB Helper ---
const DB_NAME = 'GemAI_DB';
const DB_VERSION = 1;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('chats')) {
                db.createObjectStore('chats', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('gems')) {
                db.createObjectStore('gems', { keyPath: 'id' });
            }
        };
        request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        };
        request.onerror = (event) => reject(event.target.error);
    });
}

function dbPut(storeName, item) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const req = store.put(item);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

function dbGetAll(storeName) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

function dbGet(storeName, key) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

function dbDelete(storeName, key) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const req = store.delete(key);
        req.onsuccess = () => resolve();
    });
}

// --- UI Interaction ---

document.addEventListener('DOMContentLoaded', async () => {
    await initDB();
    loadApiKey();
    setupTabs();
    setupTheme();
    setupHome();
    setupChat();
    setupHistory();
    setupGem();
    setupSettings();
});

// Navigation
function setupTabs() {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const target = item.dataset.target;
            
            // Update UI
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${target}-content`).classList.add('active');

            // Tab specific logic
            if (target === 'history') renderHistoryList();
            if (target === 'gem') renderGemList();
            if (target === 'chat' && !currentChatId) {
                // If switching to chat without active chat, clear view
                document.getElementById('chat-messages').innerHTML = '<div style="text-align: center; margin-top:20px; color:var(--md-sys-color-outline)">履歴から会話を選択してください</div>';
            }
        });
    });
}

function switchToTab(tabName) {
    document.querySelector(`.nav-item[data-target="${tabName}"]`).click();
}

// Settings & Theme
function setupTheme() {
    const toggle = document.getElementById('darkModeToggle');
    const body = document.body;
    
    // Load saved theme preference
    if (localStorage.getItem('darkMode') === 'true') {
        toggle.checked = true;
        body.classList.replace('light-mode', 'dark-mode');
    }

    toggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            body.classList.replace('light-mode', 'dark-mode');
            localStorage.setItem('darkMode', 'true');
        } else {
            body.classList.replace('dark-mode', 'light-mode');
            localStorage.setItem('darkMode', 'false');
        }
    });

    document.querySelectorAll('.color-option').forEach(opt => {
        opt.addEventListener('click', () => {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            document.documentElement.className = ''; // clear themes
            if(opt.dataset.theme !== 'blue') document.documentElement.classList.add(`theme-${opt.dataset.theme}`);
        });
    });
}

function loadApiKey() {
    const key = localStorage.getItem('geminiApiKey');
    if (key) document.getElementById('api-key-input').value = key;
}

function setupSettings() {
    document.getElementById('save-api-key').addEventListener('click', () => {
        const key = document.getElementById('api-key-input').value;
        localStorage.setItem('geminiApiKey', key);
        alert('APIキーを保存しました');
    });

    // Export
    document.getElementById('export-data').addEventListener('click', async () => {
        const chats = await dbGetAll('chats');
        const gems = await dbGetAll('gems');
        const data = { chats, gems };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gemai_backup.json';
        a.click();
    });

    // Import
    const fileInput = document.getElementById('import-file');
    document.getElementById('import-data').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if(data.chats) for(const c of data.chats) await dbPut('chats', c);
                if(data.gems) for(const g of data.gems) await dbPut('gems', g);
                alert('インポート完了しました');
            } catch(err) {
                alert('ファイルの読み込みに失敗しました');
            }
        };
        reader.readAsText(file);
    });
}

// Home
function setupHome() {
    document.getElementById('home-send-btn').addEventListener('click', async () => {
        const input = document.getElementById('home-input');
        const text = input.value.trim();
        if (!text) return;

        // Start new chat
        const chatId = Date.now().toString();
        const newChat = {
            id: chatId,
            title: text.substring(0, 30) + (text.length > 30 ? '...' : ''),
            messages: [],
            timestamp: Date.now(),
            gemId: null
        };
        await dbPut('chats', newChat);
        
        input.value = '';
        await openChat(chatId);
        await sendMessage(text); // Send the message immediately
    });
}

// Chat Logic
async function openChat(chatId) {
    currentChatId = chatId;
    const chat = await dbGet('chats', chatId);
    if (!chat) return;

    switchToTab('chat');
    renderMessages(chat.messages);
}

function renderMessages(messages) {
    const container = document.getElementById('chat-messages');
    container.innerHTML = '';
    messages.forEach(msg => appendMessageElement(msg));
    container.scrollTop = container.scrollHeight;
}

function appendMessageElement(msg) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `message-bubble ${msg.role === 'user' ? 'message-user' : 'message-ai'}`;
    div.innerText = msg.text; // Safety against XSS
    
    // Actions for AI messages
    if (msg.role === 'model') {
        const actions = document.createElement('div');
        actions.className = 'message-actions';
        
        // Copy Btn
        const copyBtn = document.createElement('span');
        copyBtn.className = 'material-symbols-outlined message-action-btn';
        copyBtn.innerText = 'content_copy';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(msg.text);
            alert('コピーしました');
        };

        // Share Btn
        const shareBtn = document.createElement('span');
        shareBtn.className = 'material-symbols-outlined message-action-btn';
        shareBtn.innerText = 'share';
        shareBtn.onclick = () => {
            if (navigator.share) {
                navigator.share({ title: 'GemAI Answer', text: msg.text });
            } else {
                alert('このデバイスは共有機能をサポートしていません');
            }
        };

        actions.append(copyBtn, shareBtn);
        div.appendChild(actions);
    }

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function setupChat() {
    const sendBtn = document.getElementById('chat-send-btn');
    const input = document.getElementById('chat-input');

    const handleSend = async () => {
        const text = input.value.trim();
        if(!text || !currentChatId) return;
        input.value = '';
        await sendMessage(text);
    };

    sendBtn.addEventListener('click', handleSend);
    // Shift+Enter for new line, Enter to send if needed. For now just button.
}

async function sendMessage(text) {
    if (!currentChatId) return;
    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        alert('設定タブでAPIキーを設定してください');
        return;
    }

    // 1. Update UI & Local DB (User)
    const chat = await dbGet('chats', currentChatId);
    const userMsg = { role: 'user', text: text };
    chat.messages.push(userMsg);
    appendMessageElement(userMsg);
    await dbPut('chats', chat);

    // 2. Prepare Context
    let promptHistory = chat.messages.map(m => ({
        role: m.role === 'user' ? 'user' : 'model',
        parts: [{ text: m.text }]
    }));

    // If Gem is used, prepend system instruction
    if (chat.gemId) {
        const gem = await dbGet('gems', chat.gemId);
        if (gem) {
            // Note: Gemini 1.5 API supports system_instruction in config, 
            // but simple prompt prepending works for old/simple implementations
            // We will insert it as the first user message or use proper field if structure allows.
            // Let's stick to prompt engineering for simplicity in this fetch wrapper.
            promptHistory.unshift({
                role: 'user',
                parts: [{ text: `System Instruction: ${gem.instructions}\n\nStart Conversation.` }]
            });
            promptHistory.splice(1, 0, { role: 'model', parts: [{ text: "Understood." }]});
        }
    }

    // 3. Call API
    try {
        // Show loading state (simple)
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message-bubble message-ai';
        loadingDiv.innerText = '...';
        loadingDiv.id = 'loading-bubble';
        document.getElementById('chat-messages').appendChild(loadingDiv);

        const response = await fetch(`${API_URL}?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: promptHistory })
        });

        const data = await response.json();
        document.getElementById('loading-bubble').remove();

        if (data.error) {
            throw new Error(data.error.message);
        }

        const responseText = data.candidates[0].content.parts[0].text;

        // 4. Update UI & Local DB (AI)
        const aiMsg = { role: 'model', text: responseText };
        chat.messages.push(aiMsg);
        await dbPut('chats', chat);
        appendMessageElement(aiMsg);

    } catch (err) {
        document.getElementById('loading-bubble')?.remove();
        alert(`Error: ${err.message}`);
    }
}

// History Tab
async function renderHistoryList() {
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    
    const chats = await dbGetAll('chats');
    // Sort descending
    chats.sort((a, b) => b.timestamp - a.timestamp);

    chats.forEach(chat => {
        const el = document.createElement('div');
        el.className = 'list-item';
        
        const isGem = chat.gemId ? '<span style="color:var(--md-sys-color-primary);">[Gem]</span> ' : '';

        el.innerHTML = `
            <div class="list-content" onclick="openChat('${chat.id}')">
                <div class="list-title">${isGem}${chat.title}</div>
                <div class="list-subtitle">${new Date(chat.timestamp).toLocaleString()}</div>
            </div>
            <div class="list-actions">
                <button class="icon-button" onclick="renameChat('${chat.id}')"><span class="material-symbols-outlined">edit</span></button>
                <button class="icon-button" onclick="deleteChat('${chat.id}')"><span class="material-symbols-outlined">delete</span></button>
            </div>
        `;
        list.appendChild(el);
    });
}

window.renameChat = async (id) => {
    const chat = await dbGet('chats', id);
    const newName = prompt('新しい会話名:', chat.title);
    if (newName) {
        chat.title = newName;
        await dbPut('chats', chat);
        renderHistoryList();
    }
};

window.deleteChat = async (id) => {
    if (confirm('この会話を削除しますか？')) {
        await dbDelete('chats', id);
        if (currentChatId === id) currentChatId = null;
        renderHistoryList();
    }
};

// Gem Tab
async function renderGemList() {
    const list = document.getElementById('gem-list');
    list.innerHTML = '';
    const gems = await dbGetAll('gems');

    gems.forEach(gem => {
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
            <div class="list-content" onclick="startGemChat('${gem.id}')">
                <div class="list-title"><span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">diamond</span> ${gem.name}</div>
                <div class="list-subtitle">${gem.instructions.substring(0, 40)}...</div>
            </div>
            <div class="list-actions">
                <button class="icon-button" onclick="editGem('${gem.id}')"><span class="material-symbols-outlined">edit</span></button>
                <button class="icon-button" onclick="deleteGem('${gem.id}')"><span class="material-symbols-outlined">delete</span></button>
            </div>
        `;
        list.appendChild(el);
    });
}

// Gem Logic
let editingGemId = null;

function setupGem() {
    const fab = document.getElementById('create-gem-fab');
    const dialog = document.getElementById('gem-dialog');
    const closeBtn = document.getElementById('close-gem-dialog');
    const saveBtn = document.getElementById('save-gem-btn');

    fab.addEventListener('click', () => {
        editingGemId = null;
        document.getElementById('gem-name').value = '';
        document.getElementById('gem-instructions').value = '';
        dialog.style.display = 'flex';
    });

    closeBtn.addEventListener('click', () => dialog.style.display = 'none');

    saveBtn.addEventListener('click', async () => {
        const name = document.getElementById('gem-name').value;
        const inst = document.getElementById('gem-instructions').value;
        if(!name || !inst) return;

        const gem = {
            id: editingGemId || Date.now().toString(),
            name: name,
            instructions: inst
        };
        await dbPut('gems', gem);
        dialog.style.display = 'none';
        renderGemList();
    });
}

window.startGemChat = async (gemId) => {
    const gem = await dbGet('gems', gemId);
    if(!gem) return;

    const chatId = Date.now().toString();
    const newChat = {
        id: chatId,
        title: `${gem.name}との会話`,
        messages: [],
        timestamp: Date.now(),
        gemId: gem.id
    };
    await dbPut('chats', newChat);
    openChat(chatId);
};

window.editGem = async (id) => {
    const gem = await dbGet('gems', id);
    if(gem) {
        editingGemId = id;
        document.getElementById('gem-name').value = gem.name;
        document.getElementById('gem-instructions').value = gem.instructions;
        document.getElementById('gem-dialog').style.display = 'flex';
    }
};

window.deleteGem = async (id) => {
    if(confirm('このGemを削除しますか？')) {
        await dbDelete('gems', id);
        renderGemList();
    }
};

</script>
</body>
</html>
